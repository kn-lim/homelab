apiVersion: argoproj.io/v1alpha1
kind: Workflow

metadata:
  name: terragrunt
  generateName: terragrunt-
  namespace: argo-workflows

spec:
  entrypoint: main
  onExit: status
  activeDeadlineSeconds: 3600
  serviceAccountName: argo-workflow
  arguments:
    parameters:
      - name: repo
        value: https://github.com/kn-lim/homelab.git
      - name: revision
        value: main
      - name: directory
      - name: terraform-version
        value: "1.14.4"
      - name: terragrunt-version
        value: "0.99.1"

  volumeClaimTemplates:
    - metadata:
        name: workdir
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 2Gi

  templates:
    - name: main
      dag:
        tasks:
          - name: git-clone
            templateRef:
              name: git-clone
              template: clone
            arguments:
              parameters:
                - name: repo
                  value: "{{workflow.parameters.repo}}"
                - name: revision
                  value: "{{workflow.parameters.revision}}"
          - name: setup
            templateRef:
              name: terragrunt
              template: setup
            arguments:
              parameters:
                - name: terraform-version
                  value: "{{workflow.parameters.terraform-version}}"
                - name: terragrunt-version
                  value: "{{workflow.parameters.terragrunt-version}}"
          - name: terragrunt-plan
            dependencies: [git-clone, setup]
            templateRef:
              name: terragrunt
              template: run
            arguments:
              parameters:
                - name: command
                  value: terragrunt stack run plan
                - name: workdir
                  value: "/workdir/src/terraform/{{workflow.parameters.directory}}"
          - name: approve
            dependencies: [terragrunt-plan]
            template: approve
          - name: terragrunt-apply
            dependencies: [approve]
            templateRef:
              name: terragrunt
              template: run
            arguments:
              parameters:
                - name: command
                  value: terragrunt stack run apply --auto-approve
                - name: workdir
                  value: "/workdir/src/terraform/{{workflow.parameters.directory}}"

    - name: approve
      suspend: {}

    - name: status
      steps:
        - - name: send-status
            templateRef:
              name: discord
              template: status
